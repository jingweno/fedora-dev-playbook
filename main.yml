- hosts: localhost
  tasks:
    # dnf packages start
    - name: Add extra dnf repos
      become: true
      command:
        cmd: 'dnf config-manager --add-repo {{ item }}'
        warn: false
      loop:
        - https://cli.github.com/packages/rpm/gh-cli.repo
    - name: Install packages
      become: true
      package:
        name:
          - bat
          - curl
          - fzf
          - gh
          - git
          - gnome-tweak-tool
          - go
          - hub
          - jq
          - kubernetes-client
          - make
          - neovim
          - openssh
          - ruby
          - tmux
          - util-linux-user
          - vim
          - vim-X11
          - xclip
          - zsh
          - zsh-syntax-highlighting
          - zsh-autosuggestions
    # dnf packages end

    - name: Change Shell to Zsh
      become: true
      command: chsh -s /usr/bin/zsh

    # Remove oh-my-zsh
    - name: Remove oh-my-zsh
      file:
        path: ~/.oh-my-zsh
        state: absent
    - include_tasks: install.yml
      with_items:
        - name: oh-my-zsh
          url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
        - name: space-vim
          url: https://raw.githubusercontent.com/liuchengxu/space-vim/master/install.sh
          args: --all
        - name: goup
          url: https://raw.githubusercontent.com/jingweno/goup/master/install.sh
          args: --skip-prompt
        - name: docker
          url: https://get.docker.com/rootless 
            #- name: nodenv
            #url: https://raw.githubusercontent.com/nodenv/nodenv-installer/master/bin/nodenv-installer
    
    # Dotfiles starts
    - name: Download Dotfiles
      git:
        repo: git@github.com:jingweno/dotfiles.git
        dest: ~/.dotfiles
    - name: Link Dotfiles
      file:
        src: '~/.dotfiles/{{ item }}'
        dest: '~/{{ item }}'
        state: link
        force: true
      loop:
        - .gemrc
        - .gitignore
        - .gitconfig
        - .irbrc
        - .spacevim
        - .tmux.conf
        - .zshrc
        - .zshrc.linux
    # Dotfiles ends

    # Rootless Docker starts
    # Ref: https://docs.docker.com/engine/security/rootless
    - name: Enable Docker
      command: systemctl --user enable docker
    - name: Start Docker
      command: systemctl --user start docker
    - name: Drop to cgroup1 for Docker
      become: true
      command: grubby --update-kernel=ALL --args="systemd.unified_cgroup_hierarchy=0"
    - name: Fix Docker Network
      become: true
      command: firewall-cmd --permanent --zone trusted --add-interface docker0
    # Rootless Docker ends
    
    # Rootful Docker starts
    # Ref: https://fedoramagazine.org/docker-and-fedora-32
    # - name: Start Docker
      # become: true
      # command: systemctl enable docker
    # - name: Add User To Docker Group
      # become: true
      # command: usermod -aG docker $USER
    # - name: Drop to cgroup1 for Docker
      # become: true
      # command: grubby --update-kernel=ALL --args="systemd.unified_cgroup_hierarchy=0"
    # - name: Fix Docker Network
      # become: true
      # command: firewall-cmd --permanent --zone trusted --add-interface docker0
    # Rootful Docker ends
    
    - name: Enable Night Light
      dconf:
        key: /org/gnome/settings-daemon/plugins/color/night-light-enabled
        value: "true"

    # Flathub starts
    - name: Enable Flathub repository
      command: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    - name: Install Flathub Packages
      command: flatpak install --assumeyes flathub {{ item }}
      loop:
        - com.discordapp.Discord
        - com.dropbox.Client
        - com.slack.Slack
        - com.spotify.Client
    # Flathub ends
